SHELL=/bin/bash

ifeq ($(strip $(QLAT_PREFIX)),)
	QLAT_PREFIX=$(shell readlink -m "$$HOME/qlat-build/default")
endif

include $(QLAT_PREFIX)/qlat/Makefile.inc

all: qlat.x

run: qlat.x
	time mpirun -x OMP_NUM_THREADS=2 --np 8 ./qlat.x | tee log

qlat.x: *.C
	time make build
	[ -f $@ ]

build:
	-time $(CXX) $(FLAGS) -o qlat.x $(CXXFLAGS) *.C $(LDFLAGS) 2>&1 | grep --color=always 'error:\|'

show-info:
	@echo CXX: $(CXX)
	@echo CXXFLAGS: $(CXXFLAGS)
	@echo LDFLAGS: $(LDFLAGS)

clean:
	-rm qlat.x
	-rm log.full
	-rm -rf results*
	-rm -rf huge-data

run-test: qlat.x
	echo > log
	time mpirun -x OMP_NUM_THREADS=2 --np 8 ./qlat.x | tee log.full
	cat log.full | egrep -v '^Timer' > log
	make diff | cat
	# make clean

diff:
	-git diff log

dist-clean: clean
	-git checkout log
